---

title: 程序员的自我修养笔记
date: 2018-12-27 23:36:40
categories: codenote
tags: [OS, Linux]
typora-copy-images-to: 程序员的自我修养笔记
typora-root-url: 程序员的自我修养笔记
---

《程序员的自我修养笔记》 1

<!--more-->

### 第二章

程序源代码到最终可执行文件的4个步骤：

- 预编译

主要处理那些源代码文件中以"#"开始的预编译指令

`gcc -E hello.c -o hello.i`

- 编译

对预编译生成的文件进行词法分析，语法分析，语义分析，中间语言生成，目标代码生成及优化生成汇编代码文件

`gcc -S hello.i -o hello.s`

- 汇编

汇编器将汇编代码转换成可执行指令,输出目标文件

`as hello.s -o hello.o`或者`gcc -c hello.s -o hello.o`或者`gcc -c hello.c -o hello.o`

- 链接

`ld -static crt1.o crti.o crtbeginT.o -start-gruoup -lgcc -lgcc_eh -lc-end-group crtend.o crtn.o`

这里省略了各文件的路径

链接过程主要有如下步骤：

- 地址和空间分配
- 符号决议
- 重定位

### 第三章

#### 目标文件格式

- 可重定位文件(Relocatable File)
- 可执行文件(Executable File)
- 共享目标文件(Shared Object File)
- 核心转储文件(Core Dump File)

>在Linux下可使用file命令显示文件格式

#### 目标文件与程序之间的关系

![1545926648771](/1545926648771.png)

- 程序源代码编译后的机器指令被放在代码段(.code或者.text)里面
- 全局变量和局部静态变量放在数据段(.data)
- 未初始化全局变量和未初始化局部静态变量，或者有些编译器也会将初始化为0的变量也放置在.bss段

> 查看目标文件内部的结构可以使用objdump工具，可看到对应的各个段大致结构(-h)，各个段详细内容(-x)，代码段内容(翻译成了汇编语言)(-s -d)

#### 其他段内容

![1545927294296](/1545927294296.png)

- 将某个二进制文件作为目标文件的一个段

  `objcopy -I binary -o elf32-i386 -B i386 image.jpg image.o`

- 将某个变量放在特定段

  `__attribute__((section("FOO"))) int global = 42`

  `__attribute__((section("BAR"))) void foo()`

### 第四章静态链接

#### 空间与地址分配

- 相似段合并

  - 空间与地址分配

    扫描所有输入目标文件，并获得他们各个段的长度、属性和位置，并将输入目标文件中的符号表所有的符号定义和符号引用收集起来，放到全局符号表中。于是，链接器将获取所有输入目标文件的段长度，并将他们合并，计算输出文件中各个段合并后的长度和位置，建立映射关系。

  - 符号解析与重定位

    利用上一步的信息进行段的数据，读取段数据，重定位信息，进行符号解析与重定位、调整代码中的地址等。

  如下图：

  ![1546439014195](/1546439014195.png)


编写程序：

```c
/*a.c*/

extern int shared;

int main(){
	int a = 100;
	swap(&a, &shared);
	return 0;
}
```

```c
/* b.c */
int shared = 1;

void swap(int *a, int *b){
	*a ^= *b  ^= *a ^=*b;
}
```

- `objdump -h a.o`

  ![1546439221303](/1546439221303.png)

- `objdump -h b.o`

  ![1546439234732](/1546439234732.png)

- 链接两个文件`ld a.o b.o -e main -o ab -lc`

  > 在我的机器上面需要加上-lc参数才能链接成功，不然报a.c:(.text+0x4b): undefined reference to `__stack_chk_fail错误，具体原因不明，
  >
  > -c:				从指定的命令文件读取命令
  >
  > -l:				把指定的存档文件添加到要连接的文件清单
  >
  > 得到的可执行文件不只是简单的链接过程，跟书中的内容有差异，有大神知道麻烦赐教

- `objdump -h ab`

  ![1546439338068](/1546439338068.png)

  可以看出，合并后得到的ab文件的`.text`段和`.data`段的长度分别是9c和4，正好等于两个.o文件相应段的长度之和。

  ![1546444190583](/1546444190583.png)

